{% extends "base.html" %}

{% block title %}Returns & Borrowed Books{% endblock %}

{% block content %}
<div class="container py-5">
  <h1 class="display-5 fw-bold mb-4 text-center">Returns & Borrowed Books</h1>

  <form method="post" action="{% url 'students:bulk_return' %}">
    {% csrf_token %}

    <div class="d-flex justify-content-between mb-3">
      <h5>Total Borrowed: {{ borrowed_books.count }}</h5>
      <button type="submit" class="btn btn-success" id="bulk-return-btn" disabled>
        <i class="fas fa-undo"></i> Return Selected
      </button>
    </div>

    <div class="table-responsive">
      <table class="table table-hover table-bordered">
        <thead class="table-dark">
          <tr>
            <th><input type="checkbox" id="select-all"></th>
            <th>Student</th>
            <th>Book</th>
            <th>Issued</th>
            <th>Due</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for borrow in borrowed_books %}
            <tr>
              <td>
                {% if borrow.status != 'RETURNED' %}
                  <input type="checkbox" name="borrow_ids" value="{{ borrow.id }}" class="borrow-checkbox">
                {% endif %}
              </td>
              <td>{{ borrow.student.name }}</td>
              <td>{{ borrow.book.title }}</td>
              <td>{{ borrow.issued_date }}</td>
              <td>{{ borrow.due_date }}</td>
              <td>
                <span class="badge {% if borrow.status == 'OVERDUE' %}bg-danger{% elif borrow.status == 'RETURNED' %}bg-success{% else %}bg-primary{% endif %}">
                  {{ borrow.status }}
                </span>
              </td>
              <td>
                {% if borrow.status != 'RETURNED' %}
                  <a href="{% url 'students:return_book' borrow.id %}?next={% url 'students:returns_list' %}" class="btn btn-sm btn-success">
                    <i class="fas fa-undo"></i> Return
                  </a>
                {% else %}
                  <span class="badge bg-success">Returned</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted py-4">No borrowed books at the moment</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="text-center mt-4">
      <a href="{% url 'students:librarian_dashboard' %}" class="btn btn-outline-secondary">Back to Dashboard</a>
    </div>
  </form>
</div>

<script>
  // Select all checkbox
  document.getElementById('select-all').addEventListener('change', function() {
    document.querySelectorAll('.borrow-checkbox').forEach(checkbox => {
      checkbox.checked = this.checked;
    });
    toggleBulkButton();
  });

  // Enable/disable bulk button based on selection
  document.querySelectorAll('.borrow-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', toggleBulkButton);
  });

  function toggleBulkButton() {
    const checked = document.querySelectorAll('.borrow-checkbox:checked').length;
    document.getElementById('bulk-return-btn').disabled = checked === 0;
  }

  // Initial check
  toggleBulkButton();
</script>
{% endblock %}